
load_module modules/ngx_http_brotli_static_module.so;
# load_module modules/ngx_http_brotli_filter_module.so;

load_module modules/ngx_http_zstd_static_module.so;
load_module modules/ngx_http_zstd_filter_module.so;

# load_module modules/ngx_http_headers_more_filter_module.so;

# load_module modules/ngx_http_geoip2_module.so;
# load_module modules/ngx_stream_geoip2_module.so;

# load_module modules/ngx_http_tcp_brutal_module.so;

# load_module modules/ngx_http_xslt_filter_module.so;
# load_module modules/ngx_http_image_filter_module.so;
# load_module modules/ngx_http_perl_module.so;

### 【only SSL Shared】

# load_module modules/ngx_http_js_module.so;
# load_module modules/ngx_stream_js_module.so;

# load_module modules/ngx_mail_module.so;

user nginx;
# grep ^processor /proc/cpuinfo | wc -l
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# pcre_jit on;

# 通过 ulimit -n 命令查询
events {
    worker_connections 1024;
}

stream {
    log_format main '[stream-log] "$proxy_protocol_addr"|"$remote_addr"|"$realip_remote_addr" '
    '["$time_local"] '
    '"$ssl_preread_server_name" "$ssl_preread_protocol" "$protocol" "$status" "$session_time" "$upstream_addr" ';

    access_log /var/log/nginx/access.log main;

    #Stream 配置文件目录
    include /etc/nginx/stream.d/*.conf;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # $http_x_forwarded_for" 真实IP
    # $proxy_protocol_addr" "$remote_addr" 真实IP
    # $request $request_uri 携带x_padding参数占位太长
    log_format main '[http-log] "$proxy_protocol_addr"|"$remote_addr"|"$http_x_forwarded_for" '
    '["$time_local"] '
    '"$host" "$ssl_server_name" "$uri" "$status" "$request_method" '
    '"$ssl_curve" "$server_protocol" "$ssl_protocol" "$ssl_sigalg" "$ssl_client_sigalg" "[TARGET]$upstream_addr" '
    '"$http_user_agent" ';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    aio threads;
    aio_write on;

    # tcp_nopush on;
    # tcp_nodelay on;

    # ssl_dyn_rec_enable on;

    # 屏蔽nginx版本号
    server_tokens off;

    # default
    # keepalive_timeout 75s;
    # keepalive_disable msie6;
    # keepalive_time 1h;

    gzip_static on;
    gzip on;
    gzip_comp_level 3;
    gzip_min_length 64;
    gzip_proxied any;
    gzip_vary on;
    # gzip_disable "msie6";
    ### https://developers.cloudflare.com/speed/optimization/content/compression/
    gzip_types
        # text/html (默认压缩,无需显式声明)
        text/richtext
        text/plain
        text/css
        text/x-script
        text/x-component
        text/x-java-source
        text/x-markdown
        application/javascript
        application/x-javascript
        text/javascript
        text/js
        image/x-icon
        image/vnd.microsoft.icon
        application/x-perl
        application/x-httpd-cgi
        text/xml
        application/xml
        application/rss+xml
        application/vnd.api+json
        application/x-protobuf
        application/json
        multipart/bag
        multipart/mixed
        application/xhtml+xml
        font/ttf
        font/otf
        font/x-woff
        image/svg+xml
        application/vnd.ms-fontobject
        application/ttf
        application/x-ttf
        application/otf
        application/x-otf
        application/truetype
        application/opentype
        application/x-opentype
        application/font-woff
        application/eot
        application/font
        application/font-sfnt
        application/wasm
        application/javascript-binast
        application/manifest+json
        application/ld+json
        application/graphql+json
        application/geo+json;
    
    zstd_static on;
    zstd on;
    zstd_comp_level 3;
    zstd_min_length 64;
    zstd_types
        # text/html (默认压缩,无需显式声明)
        text/richtext
        text/plain
        text/css
        text/x-script
        text/x-component
        text/x-java-source
        text/x-markdown
        application/javascript
        application/x-javascript
        text/javascript
        text/js
        image/x-icon
        image/vnd.microsoft.icon
        application/x-perl
        application/x-httpd-cgi
        text/xml
        application/xml
        application/rss+xml
        application/vnd.api+json
        application/x-protobuf
        application/json
        multipart/bag
        multipart/mixed
        application/xhtml+xml
        font/ttf
        font/otf
        font/x-woff
        image/svg+xml
        application/vnd.ms-fontobject
        application/ttf
        application/x-ttf
        application/otf
        application/x-otf
        application/truetype
        application/opentype
        application/x-opentype
        application/font-woff
        application/eot
        application/font
        application/font-sfnt
        application/wasm
        application/javascript-binast
        application/manifest+json
        application/ld+json
        application/graphql+json
        application/geo+json;

    # brotli压缩速度极慢，禁止动态压缩
    brotli_static on;

    # HTTP 配置文件目录
    include /etc/nginx/http.d/*.conf;
}
